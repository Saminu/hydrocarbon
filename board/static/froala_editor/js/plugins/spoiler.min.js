$.Editable.prototype.refreshSpoiler = function() {
	var element = $(this.getSelectionElement());
	if (element.hasClass('spoiler')) {
		this.$editor.find('[data-cmd="spoiler"]').addClass('active');
	}
}

$.Editable.commands = $.extend($.Editable.commands, {
	spoiler: {
		title: "Spoiler",
		icon: "fa fa-exclamation-triangle",
		refresh: $.Editable.prototype.refreshSpoiler,
		undo: true,
		callback: function() {
			this.spoiler.apply(this);
		}
	}
})

$.Editable.prototype.spoiler = function() {
	this.saveSelectionByMarkers();

	this.$element.find("span.spoiler").each(function(idx, element) {
		var container = $("<span data-fr-verified='true' style='spoiler: true'>" + $(element).html() + "</span>");
		$(element).replaceWith(container);
	});

	this.inlineStyle('spoiler', null, 'true');

	this.$element.find("span:not([style])").each(function(idx, element) {
		$(element).replaceWith($(element).html())
	});

	this.$element.find("span[style*='spoiler']").each(function(idx, element) {
		var container = $("<span data-fr-verified='true' class='spoiler'>" + $(element).html() + "</span>");
		$(element).replaceWith(container);
	});

	this.restoreSelectionByMarkers();
}
